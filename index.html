<html><head><title>Http4s Modules: Http4s Modules</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="clovellytech" /><meta name="description" content="Documenting uses of H4SM" /><meta name="og:image" content="/http4s-modules/img/poster.png" /><meta name="image" property="og:image" content="/http4s-modules/img/poster.png" /><meta name="og:title" content="Http4s Modules: Http4s Modules" /><meta name="title" property="og:title" content="Http4s Modules: Http4s Modules" /><meta name="og:site_name" content="Http4s Modules" /><meta name="og:url" content="https://clovellytech.github.io/http4s-modules" /><meta name="og:type" content="website" /><meta name="og:description" content="Documenting uses of H4SM" /><link rel="icon" type="image/png" href="/http4s-modules/img/favicon.png" /><meta name="twitter:title" content="Http4s Modules: Http4s Modules" /><meta name="twitter:image" content="https://clovellytech.github.io/http4s-modules//http4s-modules/img/poster.png" /><meta name="twitter:description" content="Documenting uses of H4SM" /><meta name="twitter:card" content="summary_large_image" /><link rel="icon" type="image/png" sizes="16x16" href="/http4s-modules/img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="24x24" href="/http4s-modules/img/favicon24x24.png" /><link rel="icon" type="image/png" sizes="32x32" href="/http4s-modules/img/favicon32x32.png" /><link rel="icon" type="image/png" sizes="48x48" href="/http4s-modules/img/favicon48x48.png" /><link rel="icon" type="image/png" sizes="57x57" href="/http4s-modules/img/favicon57x57.png" /><link rel="icon" type="image/png" sizes="60x60" href="/http4s-modules/img/favicon60x60.png" /><link rel="icon" type="image/png" sizes="64x64" href="/http4s-modules/img/favicon64x64.png" /><link rel="icon" type="image/png" sizes="70x70" href="/http4s-modules/img/favicon70x70.png" /><link rel="icon" type="image/png" sizes="72x72" href="/http4s-modules/img/favicon72x72.png" /><link rel="icon" type="image/png" sizes="76x76" href="/http4s-modules/img/favicon76x76.png" /><link rel="icon" type="image/png" sizes="96x96" href="/http4s-modules/img/favicon96x96.png" /><link rel="icon" type="image/png" sizes="114x114" href="/http4s-modules/img/favicon114x114.png" /><link rel="icon" type="image/png" sizes="120x120" href="/http4s-modules/img/favicon120x120.png" /><link rel="icon" type="image/png" sizes="128x128" href="/http4s-modules/img/favicon128x128.png" /><link rel="icon" type="image/png" sizes="144x144" href="/http4s-modules/img/favicon144x144.png" /><link rel="icon" type="image/png" sizes="150x150" href="/http4s-modules/img/favicon150x150.png" /><link rel="icon" type="image/png" sizes="152x152" href="/http4s-modules/img/favicon152x152.png" /><link rel="icon" type="image/png" sizes="196x196" href="/http4s-modules/img/favicon196x196.png" /><link rel="icon" type="image/png" sizes="310x310" href="/http4s-modules/img/favicon310x310.png" /><link rel="icon" type="image/png" sizes="310x150" href="/http4s-modules/img/favicon310x150.png" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/http4s-modules/highlight/styles/default.css" /><link rel="stylesheet" href="/http4s-modules/css/style.css" /><link rel="stylesheet" href="/http4s-modules/css/palette.css" /><link rel="stylesheet" href="/http4s-modules/css/codemirror.css" /></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><ul id="sidebar" class="sidebar-nav"><li class="sidebar-brand"><a href="/http4s-modules/" class="brand"><div class="brand-wrapper"><span>Http4s Modules</span></div></a></li><li><a href="/http4s-modules/" class=" active ">Http4s Modules</a></li></ul></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li id="gh-eyes-item" class="hidden-xs"><a href="https://github.com/clovellytech/http4s-modules"><i class="fa fa-eye"></i><span>WATCH<span id="eyes" class="label label-default">--</span></span></a></li><li id="gh-stars-item" class="hidden-xs"><a href="https://github.com/clovellytech/http4s-modules"><i class="fa fa-star-o"></i><span>STARS<span id="stars" class="label label-default">--</span></span></a></li><li><a href="#" onclick="shareSiteTwitter('Http4s Modules Documenting uses of H4SM');"><i class="fa fa-twitter"></i></a></li><li><a href="#" onclick="shareSiteFacebook('Http4s Modules Documenting uses of H4SM');"><i class="fa fa-facebook"></i></a></li><li><a href="#" onclick="shareSiteGoogle();"><i class="fa fa-google-plus"></i></a></li></ul></div></div></div></div><div id="content" data-github-owner="clovellytech" data-github-repo="http4s-modules"><div class="content-wrapper"><section><h1 id="http4s-modules">Http4s Modules</h1>

<p>This project aims to supply a basket of modules that you can pull from and configure to create a fully functional website using http4s and cats. The main goal is to provide everything in the box needed for this purpose. Instead of requiring you to create your own database schema, each module manages its own namespace of database tables. As you grow your site, ideally as another module in a similar style, you will be able to extend the provided data models by simply joining to them in your queries.</p>

<p>Let’s create a server that allows users to log in and submit feature requests for our new site.</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="nn">cats._</span>
<span class="k">import</span> <span class="nn">cats.implicits._</span>
<span class="k">import</span> <span class="nn">cats.effect.IO</span>
<span class="k">import</span> <span class="nn">h4sm._</span>
<span class="k">import</span> <span class="nn">h4sm.db.config._</span>
<span class="k">import</span> <span class="nn">io.circe.config.parser</span>
<span class="k">import</span> <span class="nn">doobie._</span>
<span class="k">import</span> <span class="nn">h4sm.db.config.DatabaseConfig</span>
</code></pre>
</div>

<h2 id="initializing-databases">Initializing Databases</h2>

<p>Database schemas come pre-packaged with each module. Here we will import the needed modules and initialize all our namespaces on the fly. We’ll import the auth module for user accounts and authentication, and the features module for our features request service.</p>

<p>The below will initialize our database schema and create a transactor that we can use for the rest of this documentation. A proper main function that would launch a server is provided as an example in <code class="highlighter-rouge">h4sm.featurerequests.Server</code></p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="nn">scala.concurrent.ExecutionContext.Implicits.global</span>
<span class="k">implicit</span> <span class="k">val</span> <span class="n">cs</span> <span class="k">=</span> <span class="nc">IO</span><span class="o">.</span><span class="n">contextShift</span><span class="o">(</span><span class="n">global</span><span class="o">)</span>
<span class="c1">// cs: effect.ContextShift[IO] = cats.effect.internals.IOContextShift@10e6ead4
</span><span class="k">val</span> <span class="n">db</span> <span class="k">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">decodePathF</span><span class="o">[</span><span class="kt">IO</span>, <span class="kt">DatabaseConfig</span><span class="o">](</span><span class="s">"db"</span><span class="o">)</span>
<span class="c1">// db: IO[DatabaseConfig] = Pure(
//   DatabaseConfig("127.0.0.1", 5432, "postgres", "", "h4sm_docs_gen")
// )
</span><span class="k">val</span> <span class="n">transactor</span> <span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">Transactor</span><span class="o">[</span><span class="kt">IO</span><span class="o">]]</span> <span class="k">=</span> <span class="n">db</span><span class="o">.</span><span class="n">flatMap</span><span class="o">(</span><span class="n">dbtesting</span><span class="o">.</span><span class="n">transactor</span><span class="o">.</span><span class="n">getInitializedTransactor</span><span class="o">(</span><span class="k">_</span><span class="o">,</span> <span class="s">"ct_auth"</span><span class="o">,</span> <span class="s">"ct_feature_requests"</span><span class="o">))</span>
<span class="c1">// transactor: IO[Transactor[IO]] = Bind(
//   Pure(DatabaseConfig("127.0.0.1", 5432, "postgres", "", "h4sm_docs_gen")),
//   &lt;function1&gt;
// )
</span><span class="k">val</span> <span class="n">xa</span> <span class="k">=</span> <span class="n">transactor</span><span class="o">.</span><span class="n">unsafeRunSync</span><span class="o">()</span>
<span class="c1">// xa: Transactor[IO] = doobie.util.transactor$Transactor$$anon$10@18451173
</span></code></pre>
</div>

<p>The <code class="highlighter-rouge">ct_auth</code> and <code class="highlighter-rouge">ct_featurerequests</code> schemas are defined in Flyway migrations in the respective resources directories for those modules. Any module can be migrated and initialized this way. Just follow the same convention as is followed in those modules.</p>

<h2 id="building-endpoints">Building endpoints</h2>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="nn">tsec.passwordhashers.jca.BCrypt</span>
<span class="k">import</span> <span class="nn">auth.infrastructure.endpoint._</span>
<span class="k">import</span> <span class="nn">featurerequests.infrastructure.endpoint._</span>

<span class="k">val</span> <span class="n">authEndpoints</span> <span class="k">=</span> <span class="nc">AuthEndpoints</span><span class="o">.</span><span class="n">persistingEndpoints</span><span class="o">(</span><span class="n">xa</span><span class="o">,</span> <span class="nc">BCrypt</span><span class="o">)</span>
<span class="c1">// authEndpoints: AuthEndpoints[IO, BCrypt] = h4sm.auth.infrastructure.endpoint.AuthEndpoints@23bccce9
</span><span class="k">val</span> <span class="n">authService</span> <span class="k">=</span> <span class="n">authEndpoints</span><span class="o">.</span><span class="nc">Auth</span>
<span class="c1">// authService: tsec.authentication.SecuredRequestHandler[IO, java.util.UUID, auth.db.domain.User, tsec.authentication.TSecBearerToken[java.util.UUID]] = tsec.authentication.SecuredRequestHandler$$anon$2@2ce55fba
</span><span class="k">val</span> <span class="n">requests</span> <span class="k">=</span> <span class="nc">RequestEndpoints</span><span class="o">.</span><span class="n">persistingEndpoints</span><span class="o">(</span><span class="n">xa</span><span class="o">)</span>
<span class="c1">// requests: RequestEndpoints[IO] = h4sm.featurerequests.infrastructure.endpoint.RequestEndpoints@20dac1b6
</span><span class="k">val</span> <span class="n">votes</span> <span class="k">=</span> <span class="nc">VoteEndpoints</span><span class="o">.</span><span class="n">persistingEndpoints</span><span class="o">(</span><span class="n">xa</span><span class="o">)</span>
<span class="c1">// votes: VoteEndpoints[IO] = h4sm.featurerequests.infrastructure.endpoint.VoteEndpoints@4168dd07
</span>
<span class="k">val</span> <span class="n">requestEndpoints</span> <span class="k">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">unAuthEndpoints</span> <span class="o">&lt;+&gt;</span> <span class="n">authService</span><span class="o">.</span><span class="n">liftService</span><span class="o">(</span><span class="n">requests</span><span class="o">.</span><span class="n">authEndpoints</span><span class="o">)</span>
<span class="c1">// requestEndpoints: data.Kleisli[data.OptionT[IO, β$0$], org.http4s.Request[IO], org.http4s.Response[IO]] = Kleisli(
//   cats.data.KleisliSemigroupK$$Lambda$5125/0x0000000101bf3040@c73b43f
// )
</span>
<span class="k">val</span> <span class="n">voteEndpoints</span> <span class="k">=</span> <span class="n">authService</span><span class="o">.</span><span class="n">liftService</span><span class="o">(</span><span class="n">votes</span><span class="o">.</span><span class="n">endpoints</span><span class="o">)</span>
<span class="c1">// voteEndpoints: org.http4s.package.HttpRoutes[IO] = Kleisli(
//   cats.data.KleisliApplicativeError$$Lambda$5124/0x0000000101bf2840@12d58487
// )
</span></code></pre>
</div>

<p>Now we can start sending some requests to our endpoints. Let’s create a user by registering, then logging in and fetching user details.</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="nn">org.http4s.implicits._</span>
<span class="k">import</span> <span class="nn">org.http4s.Uri.uri</span>
<span class="k">import</span> <span class="nn">org.http4s.dsl._</span>
<span class="k">import</span> <span class="nn">org.http4s.client.dsl._</span>

<span class="c1">// See the endpoint tests in different modules for an examples of extending 
// these dsls more generically.
</span><span class="k">object</span> <span class="nc">ioClient</span> <span class="k">extends</span> <span class="nc">Http4sDsl</span><span class="o">[</span><span class="kt">IO</span><span class="o">]</span> <span class="k">with</span> <span class="nc">Http4sClientDsl</span><span class="o">[</span><span class="kt">IO</span><span class="o">]</span>
<span class="k">import</span> <span class="nn">ioClient._</span>

<span class="k">val</span> <span class="n">authClient</span> <span class="k">=</span> <span class="n">authEndpoints</span><span class="o">.</span><span class="n">endpoints</span><span class="o">.</span><span class="n">orNotFound</span>
<span class="c1">// authClient: data.Kleisli[IO, org.http4s.Request[IO], org.http4s.Response[IO]] = Kleisli(
//   org.http4s.syntax.KleisliResponseOps$$Lambda$5126/0x0000000101bf4040@3fe5b562
// )
</span>
<span class="k">val</span> <span class="n">userReq</span> <span class="k">=</span> <span class="nc">UserRequest</span><span class="o">(</span><span class="s">"email"</span><span class="o">,</span> <span class="s">"pass"</span><span class="o">)</span>
<span class="c1">// userReq: UserRequest = UserRequest("email", "pass")
</span><span class="k">val</span> <span class="n">user</span> <span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">UserDetail</span><span class="o">]</span> <span class="k">=</span> <span class="k">for</span> <span class="o">{</span>
	<span class="n">registerReq</span> <span class="k">&lt;-</span> <span class="nc">POST</span><span class="o">(</span><span class="n">userReq</span><span class="o">,</span> <span class="n">uri</span><span class="o">(</span><span class="s">"/user"</span><span class="o">))</span>
	<span class="n">loginReq</span> <span class="k">&lt;-</span> <span class="nc">POST</span><span class="o">(</span><span class="n">userReq</span><span class="o">,</span> <span class="n">uri</span><span class="o">(</span><span class="s">"/login"</span><span class="o">))</span>
	<span class="k">_</span> <span class="k">&lt;-</span> <span class="n">authClient</span><span class="o">.</span><span class="n">run</span><span class="o">(</span><span class="n">registerReq</span><span class="o">)</span>
	<span class="n">loginRes</span> <span class="k">&lt;-</span> <span class="n">authClient</span><span class="o">.</span><span class="n">run</span><span class="o">(</span><span class="n">loginReq</span><span class="o">)</span>
	<span class="n">headers</span> <span class="k">=</span> <span class="n">loginRes</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">filter</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">toString</span><span class="o">.</span><span class="n">toLowerCase</span><span class="o">.</span><span class="n">startsWith</span><span class="o">(</span><span class="s">"authorization"</span><span class="o">))</span>
	<span class="n">userReq</span> <span class="k">&lt;-</span> <span class="nc">GET</span><span class="o">(</span><span class="n">uri</span><span class="o">(</span><span class="s">"/user"</span><span class="o">))</span>
	<span class="n">userRes</span> <span class="k">&lt;-</span> <span class="n">authClient</span><span class="o">.</span><span class="n">run</span><span class="o">(</span><span class="n">userReq</span><span class="o">.</span><span class="n">withHeaders</span><span class="o">(</span><span class="n">headers</span><span class="o">))</span>
	<span class="k">_</span> <span class="k">=</span> <span class="n">println</span><span class="o">(</span><span class="n">userRes</span><span class="o">.</span><span class="n">status</span><span class="o">)</span>
	<span class="n">u</span> <span class="k">&lt;-</span> <span class="n">userRes</span><span class="o">.</span><span class="n">as</span><span class="o">[</span><span class="kt">UserDetail</span><span class="o">]</span>
<span class="o">}</span> <span class="k">yield</span> <span class="n">u</span>
<span class="c1">// user: IO[UserDetail] = Bind(
//   Pure(
//     Request(
//       Method("POST"),
//       Uri(None, None, "/user", , None),
//       HttpVersion(1, 1),
//       Headers(Content-Type: application/json, Content-Length: 38),
//       Stream(..),
//       io.chrisdavenport.vault.Vault@436d1d10
//     )
//   ),
//   &lt;function1&gt;
// )
</span></code></pre>
</div>

</section></div></div></div></div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script><script src="/http4s-modules/highlight/highlight.pack.js"></script><script>hljs.configure({languages:['scala','java','bash']});
hljs.initHighlighting();
              </script><script>((window.gitter = {}).chat = {}).options = {
room: 'clovellytech/h4sm'};</script><script src="https://sidecar.gitter.im/dist/sidecar.v1.js"></script><script src="/http4s-modules/js/main.js"></script></body></html>